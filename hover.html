<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <!--The viewport meta tag is used to improve the presentation and behavior of the samples
    on iOS devices-->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Feature Layer - display results as an InfoWindow onHover</title>

    <link rel="stylesheet" href="http://js.arcgis.com/3.11/dijit/themes/tundra/tundra.css">
    <link rel="stylesheet" href="http://js.arcgis.com/3.11/esri/css/esri.css">
    <style>
    html, body, #mapDiv {
      padding:0;
      margin:0;
      height:100%;
    }
    #mapDiv {
      position: relative;
    }
    #info {
      background: #fff;
      box-shadow: 0 0 5px #888;
      left: 1em;
      padding: 0.5em;
      position: absolute;
      top: 1em;
      z-index: 40;
    }
    </style>

    <script src="http://js.arcgis.com/3.11/"></script>
    <script>
    var map, dialog, webmapId = "122317f9c97843e58dabe1a21bb12363";
    require([
      "esri/map", "esri/layers/FeatureLayer",
      "esri/symbols/SimpleFillSymbol", "esri/symbols/SimpleLineSymbol",
      "esri/renderers/SimpleRenderer", "esri/graphic", "esri/lang",
      "esri/Color", "dojo/number", "dojo/dom-style",
      "dijit/TooltipDialog", "dijit/popup",
      "esri/arcgis/utils", "esri/dijit/Legend",
      "esri/tasks/query", "esri/tasks/QueryTask",
      "dojo/domReady!"
      ], function(
        Map, FeatureLayer,
        SimpleFillSymbol, SimpleLineSymbol,
        SimpleRenderer, Graphic, esriLang,
        Color, number, domStyle,
        TooltipDialog, dijitPopup,
        arcgisUtils, Legend,
        Query, QueryTask
        ) {
        map = new Map("mapDiv", {
          basemap: "topo",
          center: [-0.0675706, 39.9927566],
          zoom: 19//,
          //slider: false
        });

        // arcgisUtils.createMap(webmapId, "mapDiv").then(function (response) {
        // map = response.map;
        //
        // var legend = new Legend({
        //     map: map,
        //     layerInfos:(arcgisUtils.getLegendLayers(response))
        // }, "legendDiv");
        //
        // legend.startup();
        // });

var rooms = new FeatureLayer("http://smartcampus.sg.uji.es:6080/arcgis/rest/services/SmartCampus/BuildingInteriorbyFloorNew/MapServer/8", {
  mode: FeatureLayer.MODE_SNAPSHOT,
  outFields: ["*"]
});
rooms.setDefinitionExpression("BUILDING  = 'TD' and SPACETYPE like 'A%'");

var symbol = new SimpleFillSymbol(
  SimpleFillSymbol.STYLE_SOLID,
  new SimpleLineSymbol(
    SimpleLineSymbol.STYLE_SOLID,
    new Color([255,255,255,0.35]),
    1
    ),
  new Color([125,125,125,0.35])
  );
rooms.setRenderer(new SimpleRenderer(symbol));
map.addLayer(rooms);


map.infoWindow.resize(245,125);

dialog = new TooltipDialog({
  id: "tooltipDialog",
  style: "position: absolute; width: 250px; font: normal normal normal 10pt Helvetica;z-index:100"
});
dialog.startup();

var highlightSymbol = new SimpleFillSymbol(
  SimpleFillSymbol.STYLE_SOLID,
  new SimpleLineSymbol(
    SimpleLineSymbol.STYLE_SOLID,
    new Color([255,0,0]), 3
    ),
  new Color([125,125,125,0.35])
  );


rooms.setSelectionSymbol(highlightSymbol); 


        //close the dialog when the mouse leaves the highlight graphic
        map.on("load", function(){
          map.graphics.enableMouseEvents();
          map.graphics.on("mouse-out", closeDialog);

        });


        //select busy rooms
        var queryFeature = new Query();
        queryFeature.where = "SPACEID = 'TD2108AL' ";

        rooms.queryFeatures(queryFeature, function(result){

          console.log(result);

            //get elected object id

            var feature;
            var features = result.features;
            var inBuffer = [];
          //filter out features that are not actually in buffer, since we got all points in the buffer's bounding box
          for (var i = 0; i < features.length; i++) {
            feature = features[i];
            inBuffer.push(feature.attributes[rooms.objectIdField]);
          }

          console.log(inBuffer);

          var query = new Query();
          query.objectIds = inBuffer;
          //use a fast objectIds selection query (should not need to go to the server)
          rooms.selectFeatures(query, FeatureLayer.SELECTION_NEW, function(results){
            // var totalPopulation = sumPopulation(results);
            // var r = "";
            // r = "<b>The total Census Block population within the buffer is <i>" + totalPopulation + "</i>.</b>";
            // dom.byId("messages").innerHTML = r;
          });


          //   //use a fast objectIds selection queryFeature (should not need to go to the server)
          // rooms.selectFeatures(queryFeature, FeatureLayer.SELECTION_NEW, function(results){
          //   //results.setRenderer(new SimpleRenderer(highlightSymbol));
          //   results.forEach(function(item){
          //     console.log(item);
          //     //item.setRenderer(new SimpleRenderer(highlightSymbol));
          //   });

          // });

});



var queryTask = new QueryTask("http://services1.arcgis.com/k8WRSCmxGgCwZufI/ArcGIS/rest/services/Calendar.gdb/FeatureServer/0");

var query = new Query();
query.returnGeometry = false;
query.outFields = ["*"];

        //listen for when the onMouseOver event fires on the countiesGraphicsLayer
        //when fired, create a new graphic with the geometry from the event.graphic and add it to the maps graphics layer
        rooms.on("click", function(evt){
          console.log(evt.graphic.attributes);

          query.where = "RoomNumber= '" + evt.graphic.attributes.SPACEID+ "'";
          queryTask.execute(query, showResults);

          function showResults (results) {
            console.log(results.features)
            var t = "<b>${SPACEID}</b><hr><b>Time: </b>${TIME}<br>";
                //   + "<b>2000 Population per Sq. Mi.: </b>${POP00_SQMI:NumberFormat}<br>"
                //   + "<b>2007 Population: </b>${POP2007:NumberFormat}<br>"
                //   + "<b>2007 Population per Sq. Mi.: </b>${POP07_SQMI:NumberFormat}";

                var data = {
                  SPACEID: evt.graphic.attributes.SPACEID,
                  TIME: results.features[0].attributes.Start_Date
                }

                var content = esriLang.substitute(data,t);
                var highlightGraphic = new Graphic(evt.graphic.geometry,highlightSymbol);
                map.graphics.add(highlightGraphic);

                dialog.setContent(content);

                domStyle.set(dialog.domNode, "opacity", 0.85);
                dijitPopup.open({
                  popup: dialog,
                  x: evt.pageX,
                  y: evt.pageY
                });


            //   var resultItems = [];
            //   var resultCount = results.features.length;
            //   for (var i = 0; i < resultCount; i++) {
            //     var featureAttributes = results.features[i].attributes;
            //     for (var attr in featureAttributes) {
            //       resultItems.push("<b>" + attr + ":</b>  " + featureAttributes[attr] + "<br>");
            //     }
            //     resultItems.push("<br>");
            //   }
            //   dom.byId("info").innerHTML = resultItems.join("");
          }


        });

function closeDialog() {
  map.graphics.clear();
  dijitPopup.close(dialog);
}

});
</script>
</head>
<body class="tundra">
  <div id="mapDiv">
    <div id="info">
      Hover over a county in South Carolina to get more information.
    </div>
  </div>
</body>
</html>
