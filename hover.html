<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <!--The viewport meta tag is used to improve the presentation and behavior of the samples
    on iOS devices-->
  <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
  <title>Feature Layer - display results as an InfoWindow onHover</title>

  <link rel="stylesheet" href="http://js.arcgis.com/3.11/dijit/themes/tundra/tundra.css">
  <link rel="stylesheet" href="http://js.arcgis.com/3.11/esri/css/esri.css">
  <style>
    html,
    body,
    #mapDiv {
      padding: 0;
      margin: 0;
      height: 100%;
    }
    #mapDiv {
      position: relative;
    }
    #info {
      background: #fff;
      box-shadow: 0 0 5px #888;
      left: 1em;
      padding: 0.5em;
      position: absolute;
      top: 1em;
      z-index: 40;
    }
  </style>

  <script src="http://js.arcgis.com/3.11/"></script>
  <script>
    var map, dialog, webmapId = "122317f9c97843e58dabe1a21bb12363";
    var urlCalendar = "http://services1.arcgis.com/k8WRSCmxGgCwZufI/ArcGIS/rest/services/UJICalendar.gdb/FeatureServer/0";
    var urlCurrentFloor = "http://smartcampus.sg.uji.es:6080/arcgis/rest/services/SmartCampus/BuildingInteriorbyFloorNew/MapServer/14";
    var currentDate = new Date(2014, 9, 30, 10, 0, 0);

    require([
      "esri/map", "esri/layers/FeatureLayer",
      "esri/symbols/SimpleFillSymbol", "esri/symbols/SimpleLineSymbol",
      "esri/renderers/SimpleRenderer", "esri/graphic", "esri/lang",
      "esri/Color", "dojo/number", "dojo/dom-style",
      "dijit/TooltipDialog", "dijit/popup",
      "esri/arcgis/utils", "esri/dijit/Legend",
      "esri/tasks/query", "esri/tasks/QueryTask",
      "dojo/domReady!"
    ], function(
      Map, FeatureLayer,
      SimpleFillSymbol, SimpleLineSymbol,
      SimpleRenderer, Graphic, esriLang,
      Color, number, domStyle,
      TooltipDialog, dijitPopup,
      arcgisUtils, Legend,
      Query, QueryTask
    ) {

      // DECLARATIONS

      //The base map
      map = new Map("mapDiv", {
        basemap: "topo",
        center: [-0.0675706, 39.9927566],
        zoom: 19 //,
          //slider: false
      });


      // rooms kayers

      var layerRooms = new FeatureLayer(urlCurrentFloor, {
        mode: FeatureLayer.MODE_SNAPSHOT,
        outFields: ["*"] //,
          //defaultDefinitionExpression: "BUILDING  = 'TD' and SPACETYPE like 'A%'"
      });

      //SYMPOLS

      var symbolDefault = new SimpleFillSymbol()
        .setOutline(
          new SimpleLineSymbol()
          .setColor(new Color([0, 0, 0]))
        ).setColor(new Color([53, 152, 220, 0.35]));


      var symbolSelected = new SimpleFillSymbol()
        .setOutline(
          new SimpleLineSymbol()
          .setColor(new Color([255, 0, 0]))
        ).setColor(new Color([0, 0, 0, 0.35]));

      var symbolBusy = new SimpleFillSymbol()
        .setColor(new Color([232, 76, 61]));

      var symbolFree = new SimpleFillSymbol()
        .setColor(new Color([45, 204, 112]));

      var symbolOffice = new SimpleFillSymbol()
        .setColor(new Color([241, 196, 15]));

      layerRooms.setRenderer(new SimpleRenderer(symbolDefault));
      map.addLayer(layerRooms);


      map.infoWindow.resize(245, 125);

      dialog = new TooltipDialog({
        id: "tooltipDialog",
        style: "position: absolute; width: 250px; font: normal normal normal 10pt Helvetica;z-index:100"
      });
      dialog.startup();

      //get busy
      var queryTask = new QueryTask(urlCalendar);

      var query = new Query();
      query.returnGeometry = false;
      query.outFields = ["*"];


      currentDateString = (currentDate.getMonth() + 1) + '/' + currentDate.getDate() + '/' + currentDate.getFullYear() + ' ' + currentDate.getHours() + ':' + currentDate.getMinutes() + ':' + currentDate.getSeconds();

      console.log(currentDate);
      console.log(currentDateString);

      query.where = "Start_Date <= '" + currentDateString + "' and End_Date  >= '" + currentDateString + "'";
      console.log(query.where);

      var busyRooms = [];
      queryTask.execute(query, function(results) {
        console.log(results);
        results.features.forEach(function(item) {
          busyRooms.push(item.attributes.RoomNumber);
        });

        console.log('busyRooms: ');
        console.log(busyRooms);


        //set color

        //select busy rooms
        var queryFeature = new Query();
        //queryFeature.where = "SPACEID in  (" + "'" + busyRooms.join("','") + "'" + ")";
        queryFeature.where = "1=1";
        layerRooms.queryFeatures(queryFeature, function(result) {
          result.features.forEach(function(item) {
            if (dojo.indexOf(busyRooms, item.attributes.SPACEID) > 0) {
              item.setSymbol(symbolBusy);
            }
            //map.graphics.add(item);
          });
        });







        // //select busy rooms
        // var queryFeature = new Query();
        // queryFeature.where = "SPACEID like '%AI' ";

        // rooms.queryFeatures(queryFeature, function(result) {

        //     result.features.forEach(function(item) {
        //         item.setSymbol(highlightSymbol);
        //     });
        // });





      });





      //close the dialog when the mouse leaves the highlight graphic
      map.on("load", function() {


        map.graphics.enableMouseEvents();
        map.graphics.on("mouse-out", closeDialog);

      });




      var queryTask = new QueryTask("http://services1.arcgis.com/k8WRSCmxGgCwZufI/ArcGIS/rest/services/UJICalendar.gdb/FeatureServer/0");

      var query = new Query();
      query.returnGeometry = false;
      query.outFields = ["*"];

      //listen for when the onMouseOver event fires on the countiesGraphicsLayer
      //when fired, create a new graphic with the geometry from the event.graphic and add it to the maps graphics layer
      layerRooms.on("click", function(evt) {
        console.log(evt.graphic.attributes);

        query.where = "RoomNumber= '" + evt.graphic.attributes.SPACEID + "'";
        queryTask.execute(query, showResults);

        function showResults(results) {
          console.log(results.features)
          var t = "<b>${SPACEID}</b><hr><b>Current Class: </b>${TITLE}<br>" + "<b>From:</b> ${FROM:DateFormat(selector:'time')}, <b>To:</b> ${TO:DateFormat(selector:'time')}<br>";
          //   + "<b>2007 Population: </b>${POP2007:NumberFormat}<br>"
          //   + "<b>2007 Population per Sq. Mi.: </b>${POP07_SQMI:NumberFormat}";

          var data = {
            SPACEID: evt.graphic.attributes.SPACEID,
            TITLE: results.features[0].attributes.Title,
            FROM: results.features[0].attributes.Start_Date,
            TO: results.features[0].attributes.End_Date
          }

          var content = esriLang.substitute(data, t);
          var highlightGraphic = new Graphic(evt.graphic.geometry, symbolSelected);
          map.graphics.add(highlightGraphic);

          dialog.setContent(content);

          domStyle.set(dialog.domNode, "opacity", 0.85);
          dijitPopup.open({
            popup: dialog,
            x: evt.pageX,
            y: evt.pageY
          });


          //   var resultItems = [];
          //   var resultCount = results.features.length;
          //   for (var i = 0; i < resultCount; i++) {
          //     var featureAttributes = results.features[i].attributes;
          //     for (var attr in featureAttributes) {
          //       resultItems.push("<b>" + attr + ":</b>  " + featureAttributes[attr] + "<br>");
          //     }
          //     resultItems.push("<br>");
          //   }
          //   dom.byId("info").innerHTML = resultItems.join("");
        }


      });

      function closeDialog() {
          map.graphics.clear();

        dijitPopup.close(dialog);
      }

    });
  </script>
</head>

<body class="tundra">
  <div id="mapDiv">
    <!-- <div id="info">
            Hover over a county in South Carolina to get more information.
        </div> -->
  </div>
</body>

</html>
